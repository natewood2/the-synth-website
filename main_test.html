<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Synthesizer</title>
    <link rel="stylesheet" href="./static/styles.css">
</head>
<body>
    <h1 id="header">the synth website</h1>
    <div id="menu">
        <button id="menuButton" class="dropdown"><span>menu</span></button>
        <div id="menuItems" class="dropdownContent">
            <button class="menuItem dropdown">scenes</button>
            <div id="sceneToggles" class="dropdownContent">
                <button class="toggleButton" id="dayNightToggle">Day/Night</button>
                <button class="toggleButton" id="roomToggle">room</button>
                <button class="toggleButton" id="rainToggle">rain</button>
                <button class="toggleButton" id="snowToggle">snow</button>
                <button class="toggleButton" id="starToggle">stars</button>
                <button class="toggleButton" id="spotlightToggle">spotlight</button>
            </div>
            <button class="menuItem dropdown">sequences</button>
            <div id="sequenceToggles" class="dropdownContent">
                <button class="toggleButton" id="rainToggle">fast</button>
                <button class="toggleButton" id="snowToggle">super chill</button>
                <button class="toggleButton" id="spotlightToggle">space vibes</button>
            </div>
        </div>
    </div>
    <script type="module" src="./static/scripts/menu.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FontLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/TextGeometry.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.35/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script type="module">
        import { dayNight } from './static/scripts/dayandnight.js';
        import { menuScenesSelector } from './static/scripts/menu.js';
        import { boundaries } from './static/scripts/room.js';

        // Set up scene, camera, and renderer
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Orbit controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        // Set initial camera position
        camera.position.set(0, 1.2, 0); // x, y, z
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        renderer.setClearColor(new THREE.Color('skyblue'));

        // Synthesizer setup
        // const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        // const synth = new Tone.NoiseSynth().toDestination();
        // const synth = new Tone.Synth().toDestination();
        // const synth = new Tone.AMSynth().toDestination();
        // const synth = new Tone.FMSynth().toDestination();
        const synth = new Tone.DuoSynth().toDestination();
        // const synth = new Tone.MonoSynth().toDestination();

        
        

        // effects
        const reverb = new Tone.Reverb(1.5).toDestination();
        const delay = new Tone.FeedbackDelay("8n", 0.5).toDestination();
        const chorus = new Tone.Chorus(4, 2.5, 0.5).toDestination();
        const autoWah = new Tone.AutoWah({ baseFrequency: 100, octaves: 6 }).toDestination();
        const distortion = new Tone.Distortion(0.2).toDestination();

        // effect chain
        synth.chain(chorus, delay, reverb, autoWah, distortion, Tone.Destination);
        // Load texture
        const textureLoader = new THREE.TextureLoader();
        const synthTexture = textureLoader.load('./static/textures/Plastic005_1K-JPG_Color.jpg');

        // Scene Effects
        menuScenesSelector(scene);
        dayNight(scene, 'on'); // Set to day time by default

        let synthObj;
        const buttons = [];
        const lights = [];

        // Load the GLTF model
        const loader = new THREE.GLTFLoader();
        loader.load('./static/assets/synth.glb', function (gltf) {
            scene.add(gltf.scene);
            synthObj = gltf;

        // Traverse the GLTF scene to find the buttons and lights
        gltf.scene.traverse((child) => {
            if (child.isMesh && child.name.startsWith('button-')) {
                const index = parseInt(child.name.split('-')[1], 10);
                child.userData.note = getNoteFromIndex(index);
                buttons[index] = child;
            }
            if (child.isMesh && child.name.startsWith('light-')) {
                const index = parseInt(child.name.split('-')[1], 10);
                lights[index] = child;
            }
            if (child.isMesh && child.name === 'play-button') {
                child.userData.isPlayButton = true;
            }
        });
        console.log('Buttons:', buttons);
        console.log('Lights:', lights);
    }, undefined, function (error) {
        console.error(error);
    });

    function getNoteFromIndex(index) {
        const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
        return notes[index - 1] || 'C4';
    }

    let noteSequence = Array(8).fill(false);
    let isPlaying = false;
    let timeouts = [];

    document.addEventListener('click', function(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(scene.children, true);

        if (intersects.length > 0) {
            const intersectedObject = intersects[0].object;
            if (intersectedObject.userData.note) {
                const index = parseInt(intersectedObject.name.split('-')[1], 10) - 1;
                noteSequence[index] = !noteSequence[index]; // Toggle the step
                let buttonColor = intersectedObject.material.color;
                buttonColor.set(noteSequence[index] ? 0xff0000 : 0xFFFFE0);
                console.log(`Note toggled: ${intersectedObject.userData.note}, Index: ${index}, Active: ${noteSequence[index]}`);
            }
            if (intersectedObject.userData.isPlayButton) {
                console.log('Note sequence:', noteSequence);
                if (!isPlaying) {
                    startSequence();
                } else {
                    stopSequence();
                }
            }
        }
    });

    function startSequence() {
        // Clear any existing timeouts
        timeouts.forEach(clearTimeout);
        timeouts = [];

        isPlaying = true;
        playSequence();
    }

    function stopSequence() {
        isPlaying = false;

        // Clear all timeouts
        timeouts.forEach(clearTimeout);
        timeouts = [];

        // Turn off all lights
        lights.forEach(light => {
            if (light) {
                light.material.color.set(0x000000);
            }
        });

        // Stop all playing notes
        synth.releaseAll();
    }

    function playSequence() {
        if (!isPlaying) return;

        console.log('Playing sequence');
        let now = Tone.now();

        noteSequence.forEach((isActive, index) => {
            const time = now + index * 0.5;
            const buttonIndex = index;

            timeouts.push(setTimeout(() => {
                if (!isPlaying) return;
                const light = lights[buttonIndex + 1];
                if (light) {
                    light.material.color.set(0xff0000);
                }
            }, (time - now) * 1000));

            timeouts.push(setTimeout(() => {
                if (!isPlaying) return;
                const light = lights[buttonIndex + 1];
                if (light) {
                    light.material.color.set(0x000000);
                }
            }, (time - now + 0.3) * 1000));

            if (isActive) {
                const note = getNoteFromIndex(buttonIndex + 1);
                synth.triggerAttackRelease(note, '8n', time);
            }
        });

        timeouts.push(setTimeout(() => playSequence(), noteSequence.length * 0.5 * 1000));
    }

    // need to run the three.js
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    // Handle window resize
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
    </script>
</body>
</html>