<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drum Pad Sequencer</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        .controls { position: absolute; top: 10px; left: 10px; }
    </style>
</head>
<body>
    <div class="controls">
        <button id="startButton">Start Audio</button>
        <button id="playButton">Play</button>
        <button id="stopButton">Stop</button>
        <button id="kickMemoryButton">Kick</button>
        <button id="snareMemoryButton">Snare</button>
        <button id="hihatMemoryButton">Hihat</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.35/Tone.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        const padRows = 4;
        const padCols = 4;
        const padSize = 1;
        const pads = [];

        for (let i = 0; i < padRows; i++) {
            for (let j = 0; j < padCols; j++) {
                const geometry = new THREE.BoxGeometry(padSize, padSize, padSize / 2);
                const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const pad = new THREE.Mesh(geometry, material);
                pad.position.set(j - padCols / 2, i - padRows / 2, 0);
                pad.userData = { row: i, col: j, active: false };
                scene.add(pad);
                pads.push(pad);
            }
        }

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 5, 5).normalize();
        scene.add(directionalLight);

        camera.position.z = 5;

        const kick = new Tone.MembraneSynth().toDestination();
        const snare = new Tone.NoiseSynth({ 
            noise: { type: 'white' }, 
            envelope: { attack: 0.001, decay: 0.2, sustain: 0 } 
        }).toDestination();
        const hihat = new Tone.MetalSynth({
            frequency: 200, 
            envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
            harmonicity: 5.1,
            modulationIndex: 32,
            resonance: 4000,
            octaves: 1.5
        }).toDestination();

        const drumKit = { kick, snare, hihat };

        const memories = {
            kick: Array(padRows * padCols).fill(false),
            snare: Array(padRows * padCols).fill(false),
            hihat: Array(padRows * padCols).fill(false)
        };
        let currentMemory = "kick";

        function playStep() {
            const activePadsKick = memories.kick;
            const activePadsSnare = memories.snare;
            const activePadsHihat = memories.hihat;
            
            for (let i = 0; i < padRows; i++) {
                for (let j = 0; j < padCols; j++) {
                    const padIndex = i * padCols + j;
                    const pad = pads[padIndex];

                    pad.material.color.set(padIndex % padCols === index ? 0xff0000 : 0x00ff00);

                    if (index === j) {
                        if (activePadsKick[padIndex]) drumKit.kick.triggerAttackRelease("C2", "8n");
                        if (activePadsSnare[padIndex]) drumKit.snare.triggerAttackRelease("8n");
                        if (activePadsHihat[padIndex]) drumKit.hihat.triggerAttackRelease("8n");
                    }
                }
            }
            index = (index + 1) % padCols;
        }

        let index = 0;
        let interval;

        document.getElementById('playButton').addEventListener('click', () => {
            interval = setInterval(playStep, 500);  // Set interval to 500 milliseconds
        });

        document.getElementById('stopButton').addEventListener('click', () => {
            clearInterval(interval);
        });

        document.getElementById('kickMemoryButton').addEventListener('click', () => {
            currentMemory = "kick";
            updatePadColors();
        });

        document.getElementById('snareMemoryButton').addEventListener('click', () => {
            currentMemory = "snare";
            updatePadColors();
        });

        document.getElementById('hihatMemoryButton').addEventListener('click', () => {
            currentMemory = "hihat";
            updatePadColors();
        });

        function updatePadColors() {
            const activePads = memories[currentMemory];
            for (let i = 0; i < padRows; i++) {
                for (let j = 0; j < padCols; j++) {
                    const pad = pads[i * padCols + j];
                    pad.material.color.set(activePads[i * padCols + j] ? 0xff0000 : 0x00ff00);
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        window.addEventListener('click', (event) => {
            const mouse = new THREE.Vector2();
            const raycaster = new THREE.Raycaster();

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(pads);
            if (intersects.length > 0) {
                const pad = intersects[0].object;
                const padIndex = pad.userData.row * padCols + pad.userData.col;
                const activePads = memories[currentMemory];
                activePads[padIndex] = !activePads[padIndex];
                pad.material.color.set(activePads[padIndex] ? 0xff0000 : 0x00ff00);
            }
        });

        // Start AudioContext on user action
        document.getElementById('startButton').addEventListener('click', () => {
            Tone.start();
            console.log('Audio context started');
        });
    </script>
</body>
</html>